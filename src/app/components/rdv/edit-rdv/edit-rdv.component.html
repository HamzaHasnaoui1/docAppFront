<div class="form-card">
  <nz-card [nzLoading]="loading" nzTitle="Modifier le rendez-vous">
    <form [formGroup]="rdvForm" (ngSubmit)="onSubmit()">
      <!-- Informations de base du RDV -->
      <div class="section-card">
        <h3>Informations générales</h3>
        <nz-row [nzGutter]="16">
          <nz-col [nzXs]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label [nzSpan]="24">Date et heure</nz-form-label>
              <input
                nz-input
                formControlName="date"
                type="datetime-local"
                [ngClass]="{'input-error': rdvForm.get('date')?.invalid && rdvForm.get('date')?.touched}"
                class="full-width"
              />
            </nz-form-item>
          </nz-col>
          <nz-col [nzXs]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label [nzSpan]="24">Statut</nz-form-label>
              <nz-select formControlName="statusRDV" nzPlaceHolder="Statut du rendez-vous" class="full-width">
                <nz-option nzValue="PENDING" nzLabel="En attente"></nz-option>
                <nz-option nzValue="CONFIRMED" nzLabel="Confirmé"></nz-option>
                <nz-option nzValue="COMPLETED" nzLabel="Terminé"></nz-option>
                <nz-option nzValue="CANCELLED" nzLabel="Annulé"></nz-option>
              </nz-select>
            </nz-form-item>
          </nz-col>
        </nz-row>

        <nz-row [nzGutter]="16">
          <nz-col [nzXs]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label [nzSpan]="24">Médecin</nz-form-label>
              <input nz-input [value]="medecin" disabled class="full-width" />
            </nz-form-item>
          </nz-col>
          <nz-col [nzXs]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label [nzSpan]="24">Patient</nz-form-label>
              <input nz-input [value]="patient" disabled class="full-width" />
            </nz-form-item>
          </nz-col>
        </nz-row>

        <!-- Prix -->
        <nz-row [nzGutter]="16">
          <nz-col [nzXs]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label [nzSpan]="24">Prix (DH)</nz-form-label>
              <nz-input-number
                formControlName="prix"
                [nzMin]="0"
                [nzMax]="1000"
                [nzStep]="1"
                [nzPlaceHolder]="'Prix de la consultation'"
              ></nz-input-number>
            </nz-form-item>
          </nz-col>
        </nz-row>
      </div>

      <!-- Rapport de consultation -->
      <div class="section-card">
        <h3>Rapport de consultation</h3>
        <nz-form-item>
          <textarea
            nz-input
            formControlName="rapport"
            [nzAutosize]="{ minRows: 2, maxRows: 6 }"
            placeholder="Saisissez les détails de la consultation"
            class="full-width"
          ></textarea>
        </nz-form-item>
      </div>

      <!-- Ordonnance -->
      <div formGroupName="ordonnance" class="section-card">
        <h3>Ordonnance</h3>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Contenu</nz-form-label>
          <textarea
            nz-input
            formControlName="contenu"
            [nzAutosize]="{ minRows: 2, maxRows: 6 }"
            placeholder="Contenu général de l'ordonnance"
            class="full-width"
          ></textarea>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Remarques</nz-form-label>
          <textarea
            nz-input
            formControlName="remarques"
            [nzAutosize]="{ minRows: 2, maxRows: 6 }"
            placeholder="Remarques supplémentaires"
            class="full-width"
          ></textarea>
        </nz-form-item>

        <!-- Liste des médicaments -->
        <div class="medicaments-section">
          <div class="medicaments-header">
            <h3>Médicaments</h3>
            <button
              nz-button
              nzType="primary"
              (click)="addMedicament()"
              type="button"
            >
              <span nz-icon nzType="plus"></span> Ajouter un médicament
            </button>
          </div>

          <div class="medicaments-list" formArrayName="medicaments">
            <nz-card
              *ngFor="let medControl of medicaments.controls; let i = index"
              class="medicament-card"
              [formGroupName]="i"
              [nzBordered]="false"
            >
              <div class="medicament-header">
                <h4>Médicament #{{ i + 1 }}</h4>
                <button
                  nz-button
                  nzDanger
                  nzShape="circle"
                  nzType="text"
                  type="button"
                  (click)="removeMedicament(i)"
                >
                  <span nz-icon nzType="delete"></span>
                </button>
              </div>

              <nz-row [nzGutter]="16">
                <nz-col [nzXs]="24" [nzMd]="12">
                  <nz-form-item>
                    <nz-form-label [nzSpan]="24" nzRequired>Médicament</nz-form-label>
                    <nz-select
                      formControlName="medicamentId"
                      nzShowSearch
                      [nzLoading]="isLoadingMeds"
                      [nzPlaceHolder]="'Sélectionner un médicament'"
                      (nzOnSearch)="onSearchMedicament($event)"
                      class="full-width"
                    >
                      <nz-option
                        *ngFor="let med of medicamentsList"
                        [nzValue]="med.id"
                        [nzLabel]="med.nom">
                      </nz-option>
                    </nz-select>
                  </nz-form-item>
                </nz-col>
                <nz-col [nzXs]="24" [nzMd]="12">
                  <nz-form-item>
                    <nz-form-label [nzSpan]="24" nzRequired>Posologie</nz-form-label>
                    <input
                      nz-input
                      formControlName="posologie"
                      placeholder="ex: 1 comprimé 3 fois par jour"
                      class="full-width"
                    />
                  </nz-form-item>
                </nz-col>
              </nz-row>

              <nz-row [nzGutter]="16">
                <nz-col [nzXs]="24" [nzMd]="8">
                  <nz-form-item>
                    <nz-form-label [nzSpan]="24">Durée</nz-form-label>
                    <input
                      nz-input
                      formControlName="duree"
                      placeholder="ex: 7 jours"
                      class="full-width"
                    />
                  </nz-form-item>
                </nz-col>
                <nz-col [nzXs]="24" [nzMd]="8">
                  <nz-form-item>
                    <nz-form-label [nzSpan]="24">Fréquence</nz-form-label>
                    <input
                      nz-input
                      formControlName="frequence"
                      placeholder="ex: pendant les repas"
                      class="full-width"
                    />
                  </nz-form-item>
                </nz-col>
                <nz-col [nzXs]="24" [nzMd]="8">
                  <nz-form-item>
                    <nz-form-label [nzSpan]="24">Instructions</nz-form-label>
                    <input
                      nz-input
                      formControlName="instructions"
                      placeholder="ex: à prendre avec de l'eau"
                      class="full-width"
                    />
                  </nz-form-item>
                </nz-col>
              </nz-row>
            </nz-card>

            <div *ngIf="medicaments.controls.length === 0" class="empty-medicaments">
              <p>Aucun médicament ajouté à l'ordonnance</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button nz-button (click)="onCancel()" type="button">Annuler</button>
        <button nz-button nzType="primary" type="submit" [disabled]="rdvForm.invalid" class="save-btn">Enregistrer</button>
      </div>
    </form>
  </nz-card>
</div>
